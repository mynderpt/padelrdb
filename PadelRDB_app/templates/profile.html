<!DOCTYPE html>
{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}

<div class="profile-container">
    <!-- Profile Section -->
    <div class="profile-header">
        <div class="profile-pic-container">
            <img src="{{ user.profile_image.url }}" alt="Profile Picture" class="profile-pic">
        </div>
        <h2 class="username">{{ user.username }}</h2>
        <div class="profile-buttons">
            <input type="file" id="fileInput" accept="image/*" style="display: none;" />
            <button class="btn upload-pht" onclick="document.getElementById('fileInput').click();">Upload New
                Photo</button>
            <button class="btn delete-pht" onclick="confirmDeletePhoto()">Delete Photo</button>
        </div>
    </div>


    <!-- Reviews Section -->
    <section class="reviews-section">
        <h2>Your Reviews</h2>
        {% if reviews %}
        {% for brand, reviews_list in reviews.items %}
        <div class="brand-section">
            <h3>{{ brand|capfirst }}</h3>
            <div class="racket-grid">
                {% for review in reviews_list %}
                <div class="racket-card">
                    <a href="{% url 'racket_detail' name=review.racket.brand.name|lower slug=review.racket.slug %}">
                        <img src="{{ review.racket.thumbnail.url }}" class="card-img-top"
                            alt="{{ review.racket.name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ review.racket.name }}</h5>
                        </div>
                    </a>
                    <div class="review-buttons">
                        <a href="{% url 'review_view' review.racket.slug %}" class="btn edit-btn">Edit</a>
                        <button class="btn delete-btn" onclick="confirmDelete({{ review.id }})">Delete</button>

                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p>You haven't reviewed any rackets yet.</p>
        {% endif %}
    </section>

    <!-- Account Settings -->
    <div class="account-actions">
        <!-- Change Password Link -->
        <a href="{% url 'change_password' %}" class="btn change-button">
            Change Password
        </a>

        <!-- Delete Account & Logout -->
        <a href="#" class="btn delete-account">Delete Account</a>
        <button type="button" class="btn logout" onclick="confirmLogout()">Logout</button>
    </div>


    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutConfirmModal" tabindex="-1" aria-labelledby="logoutConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutConfirmModalLabel">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to log out?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a id="confirmLogoutBtn" class="btn btn-danger" href="{% url 'logout' %}">Yes, Logout</a>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal for Image Upload -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2>Change Profile Picture</h2>
            <form action="#" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="profile_image" accept="image/*">
                <button type="submit" class="btn">Upload</button>
            </form>
        </div>
    </div>

    <!-- Delete Review Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this review?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a id="confirmDeleteBtn" class="btn btn-danger" href="#">Yes, Delete</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Profile Photo Confirmation Modal -->
<div class="modal fade" id="deletePhotoModal" tabindex="-1" aria-labelledby="deletePhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePhotoModalLabel">Confirm Photo Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete your profile photo?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePhotoBtn">Yes, Delete</button>
            </div>
        </div>
    </div>
</div>


<script>


    function confirmLogout() {
        const modal = new bootstrap.Modal(document.getElementById("logoutConfirmModal"));
        modal.show();
    }





    function openModal() {
        document.getElementById("profileModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("profileModal").style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        let modal = document.getElementById("profileModal");
        if (event.target == modal) {
            closeModal();
        }
    };


    function confirmDelete(reviewId) {
        const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
        const deleteBtn = document.getElementById("confirmDeleteBtn");

        // Set the href dynamically
        deleteBtn.href = `/review/delete/${reviewId}/`;; // <-- Adjust to your actual URL pattern

        modal.show();
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('profile_image', file);

            fetch('/upload-profile-photo/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken() // Ensure CSRF protection if using Django
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('profilePic').src = data.image_url;
                        window.location.reload();  // ✅ Instant refresh after delete
                    } else {
                        alert('Error uploading image.');
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    });

    // Function to open the Delete Photo modal
    function confirmDeletePhoto() {
        const modal = new bootstrap.Modal(document.getElementById("deletePhotoModal"));

        // Attach the delete functionality to the confirmation button
        const deleteBtn = document.getElementById("confirmDeletePhotoBtn");

        deleteBtn.addEventListener('click', function () {
            // Call delete photo function
            deletePhoto();
            modal.hide();  // Hide the modal after deletion
        });

        // Show the modal
        modal.show();
    }

    // Modify the deletePhoto function to handle profile photo deletion
    function deletePhoto() {
        fetch('/delete-profile-photo/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('profilePic').src = data.default_image_url;
                    window.location.reload();  // ✅ Instant refresh after delete
                } else {
                    alert('Error deleting image.');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Function to get CSRF Token (Needed for Django)
    function getCSRFToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }



</script>



{% endblock %}